<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro diario de compras</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
font-family:Arial;
background:#0f172a;
color:white;
margin:0;
padding:12px;
}

.box{
max-width:980px;
margin:auto;
background:#020617;
padding:14px;
border-radius:10px;
}

input,button{
padding:8px;
border-radius:7px;
border:none;
font-size:14px;
}

button{
background:#38bdf8;
font-weight:bold;
cursor:pointer;
}

table{
width:100%;
border-collapse:separate;
border-spacing:0 8px;
margin-top:14px;
font-size:14px;
}

th,td{
padding:10px 14px;
border-bottom:1px solid #1f2933;
white-space:nowrap;
}

th{
text-align:left;
}

td:nth-child(1){min-width:110px;}
td:nth-child(2){min-width:60px;}
td:nth-child(3){min-width:180px;}
td:nth-child(4){min-width:90px;}
td:nth-child(5){
min-width:110px;
text-align:right;
font-weight:bold;
}

.total-dia{
background:#111827;
font-weight:bold;
}

.total-general{
margin-top:12px;
font-size:18px;
font-weight:bold;
color:#22d3ee;
text-align:right;
}

.formTop{
display:grid;
grid-template-columns:1fr auto auto;
gap:10px;
margin-bottom:14px;
align-items:center;
}

.linea{
display:grid;
grid-template-columns:90px 1fr 110px 110px;
gap:10px;
margin-bottom:10px;
align-items:center;
}

.sub{
color:#38bdf8;
font-weight:bold;
text-align:right;
padding-right:6px;
}

hr{border:0;border-top:1px solid #1f2933;margin:12px 0;}
</style>
</head>
<body>

<div class="box">

<h3>Registro de compras</h3>

<div class="formTop">
<input type="date" id="fecha">
<button type="button" id="btnGuardar">Guardar día</button>
<button type="button" onclick="generarPDF()">Exportar PDF</button>
</div>

<div id="lineas"></div>

<hr>

<table>
<thead>
<tr>
<th>Fecha</th>
<th>Cant.</th>
<th>Concepto</th>
<th>Precio</th>
<th>Importe</th>
<th>Editar</th>
<th></th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total-general">
Total general: $ <span id="totalGeneral">0.00</span>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const lineasDiv = document.getElementById("lineas");
const tabla = document.getElementById("tabla");
const btnGuardar = document.getElementById("btnGuardar");

let compras = JSON.parse(localStorage.getItem("comprasCantidad") || "[]");

document.getElementById("fecha").value =
new Date().toISOString().split("T")[0];

function crearLineas(){

lineasDiv.innerHTML="";

for(let i=1;i<=5;i++){

const fila = document.createElement("div");
fila.className = "linea";

fila.innerHTML = `
<input type="number" min="1" id="q${i}" placeholder="Cant.">
<input type="text" id="c${i}" placeholder="Concepto">
<input type="number" step="0.01" id="m${i}" placeholder="Precio">
<div class="sub" id="s${i}">$ 0.00</div>
`;

lineasDiv.appendChild(fila);

document.getElementById("q"+i).addEventListener("input",()=>calcLinea(i));
document.getElementById("m"+i).addEventListener("input",()=>calcLinea(i));
}
}

crearLineas();

function calcLinea(i){
const q = parseFloat(document.getElementById("q"+i).value) || 0;
const p = parseFloat(document.getElementById("m"+i).value) || 0;
document.getElementById("s"+i).textContent = "$ " + (q*p).toFixed(2);
}

btnGuardar.addEventListener("click",agregarDia);

function agregarDia(){

const fecha = document.getElementById("fecha").value;
if(!fecha){ alert("Selecciona fecha"); return; }

let agrego = false;

for(let i=1;i<=5;i++){

const q = parseFloat(document.getElementById("q"+i).value);
const c = document.getElementById("c"+i).value.trim();
const p = parseFloat(document.getElementById("m"+i).value);

if(c && !isNaN(q) && !isNaN(p)){

compras.push({
fecha,
cantidad:q,
concepto:c,
precio:p,
importe:q*p
});

agrego = true;
}
}

if(!agrego){
alert("No hay líneas válidas");
return;
}

guardar();
pintar();
limpiar();
}

function limpiar(){
for(let i=1;i<=5;i++){
document.getElementById("q"+i).value="";
document.getElementById("c"+i).value="";
document.getElementById("m"+i).value="";
document.getElementById("s"+i).textContent="$ 0.00";
}
}

function guardar(){
localStorage.setItem("comprasCantidad",JSON.stringify(compras));
}

function borrar(i){
if(!confirm("¿Eliminar registro?")) return;
compras.splice(i,1);
guardar();
pintar();
}

function editar(i){

const r = compras[i];

const cant = prompt("Cantidad",r.cantidad);
if(cant===null) return;

const conc = prompt("Concepto",r.concepto);
if(conc===null) return;

const prec = prompt("Precio",r.precio);
if(prec===null) return;

const q = parseFloat(cant);
const p = parseFloat(prec);

if(isNaN(q) || isNaN(p)){
alert("Datos inválidos");
return;
}

r.cantidad = q;
r.concepto = conc;
r.precio = p;
r.importe = q*p;

guardar();
pintar();
}

function pintar(){

tabla.innerHTML="";
let totalGeneral = 0;

const grupos = {};

compras.forEach((c,i)=>{
if(!grupos[c.fecha]) grupos[c.fecha]=[];
grupos[c.fecha].push({...c,index:i});
});

Object.keys(grupos).sort().forEach(fecha=>{

let totalDia = 0;

grupos[fecha].forEach(r=>{

totalDia += r.importe;
totalGeneral += r.importe;

const tr = document.createElement("tr");

tr.innerHTML = `
<td>${fecha}</td>
<td>${r.cantidad}</td>
<td>${r.concepto}</td>
<td>$ ${r.precio.toFixed(2)}</td>
<td>$ ${r.importe.toFixed(2)}</td>
<td><button type="button" onclick="editar(${r.index})">✏️</button></td>
<td><button type="button" onclick="borrar(${r.index})">✖</button></td>
`;

tabla.appendChild(tr);

});

const trTotal = document.createElement("tr");
trTotal.className="total-dia";
trTotal.innerHTML=`
<td colspan="4">Total del día (${fecha})</td>
<td>$ ${totalDia.toFixed(2)}</td>
<td></td>
<td></td>
`;

tabla.appendChild(trTotal);

});

document.getElementById("totalGeneral").textContent =
totalGeneral.toFixed(2);
}

pintar();

/* ---------------- PDF ---------------- */

function generarPDF(){

if(compras.length===0){
alert("No hay datos");
return;
}

const { jsPDF } = window.jspdf;
const doc = new jsPDF();

let y = 12;

doc.setFontSize(14);
doc.text("Registro de compras",10,y);
y+=8;

const grupos = {};
let totalGeneral = 0;

compras.forEach(c=>{
if(!grupos[c.fecha]) grupos[c.fecha]=[];
grupos[c.fecha].push(c);
});

Object.keys(grupos).sort().forEach(fecha=>{

let totalDia=0;

doc.setFontSize(11);
doc.text("Fecha: "+fecha,10,y);
y+=6;

doc.setFontSize(10);
doc.text("Cant.",10,y);
doc.text("Concepto",28,y);
doc.text("Precio",120,y);
doc.text("Importe",160,y);
y+=4;

grupos[fecha].forEach(r=>{

doc.text(String(r.cantidad),10,y);
doc.text(r.concepto,28,y,{maxWidth:85});
doc.text("$ "+r.precio.toFixed(2),120,y);
doc.text("$ "+r.importe.toFixed(2),160,y);

totalDia+=r.importe;
totalGeneral+=r.importe;

y+=6;

if(y>275){
doc.addPage();
y=12;
}

});

doc.text("Total del día:",120,y);
doc.text("$ "+totalDia.toFixed(2),160,y);

y+=10;

if(y>275){
doc.addPage();
y=12;
}

});

doc.setFontSize(12);
doc.text("Total general: $ "+totalGeneral.toFixed(2),10,y);

doc.save("registro-compras.pdf");
}
</script>

</body>
</html>
